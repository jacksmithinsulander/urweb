#!/bin/sh
# configure -- urweb build configuration (generates config.h, config.sml, build.ninja)
set -e

srcdir=$(cd "$(dirname "$0")"; pwd)
builddir=$srcdir
prefix=/usr/local
CC=${CC:-cc}
MLTON=${MLTON:-mlton}

# ── Command-line options ──────────────────────────────────────────────────────
for arg; do
    case $arg in
        --prefix=*)   prefix=${arg#*=} ;;
        --builddir=*) builddir=${arg#*=} ;;
        CC=*)         CC=${arg#*=} ;;
        MLTON=*)      MLTON=${arg#*=} ;;
        *) printf 'Unknown option: %s\n' "$arg" >&2; exit 1 ;;
    esac
done

BIN=${BIN:-$prefix/bin}
LIB=${LIB:-$prefix/lib}
SRCLIB=${SRCLIB:-$prefix/lib/urweb}
INCLUDE=${INCLUDE:-$prefix/include/urweb}
SITELISP=${SITELISP:-$prefix/share/emacs/site-lisp/urweb-mode}

printf 'srcdir:   %s\n' "$srcdir"
printf 'builddir: %s\n' "$builddir"
printf 'prefix:   %s\n' "$prefix"
printf 'CC:       %s\n' "$CC"

# ── Required tools ────────────────────────────────────────────────────────────
check_prog() {
    if ! command -v "$1" >/dev/null 2>&1; then
        printf 'Error: %s not found in PATH\n' "$1" >&2; exit 1
    fi
    printf '  found: %s -> %s\n' "$1" "$(command -v "$1")"
}

printf 'Checking required tools...\n'
check_prog "$CC"
check_prog "$MLTON"
check_prog mllex
check_prog mlyacc
check_prog pkg-config

# ── pthread ───────────────────────────────────────────────────────────────────
PTHREAD_CFLAGS=-pthread
PTHREAD_LIBS=-lpthread

# ── ICU ───────────────────────────────────────────────────────────────────────
printf 'Checking ICU... '
if ICU_LIBS=$(pkg-config --libs icu-i18n 2>/dev/null) && \
   ICU_INCLUDES=$(pkg-config --cflags icu-i18n 2>/dev/null); then
    printf 'ok (%s)\n' "$ICU_LIBS"
else
    # Try common Homebrew locations for icu4c
    for icu_pc in /opt/homebrew/opt/icu4c/lib/pkgconfig /usr/local/opt/icu4c/lib/pkgconfig; do
        if [ -d "$icu_pc" ]; then
            export PKG_CONFIG_PATH="${icu_pc}${PKG_CONFIG_PATH:+:$PKG_CONFIG_PATH}"
            if ICU_LIBS=$(pkg-config --libs icu-i18n 2>/dev/null) && \
               ICU_INCLUDES=$(pkg-config --cflags icu-i18n 2>/dev/null); then
                printf 'ok via %s (%s)\n' "$icu_pc" "$ICU_LIBS"
                break
            fi
        fi
    done
    if [ -z "$ICU_LIBS" ] || [ -z "$ICU_INCLUDES" ]; then
        printf 'not found via pkg-config\n' >&2
        printf 'Hint: set PKG_CONFIG_PATH to your ICU lib/pkgconfig directory\n' >&2
        exit 1
    fi
fi

# ── libunistring ──────────────────────────────────────────────────────────────
printf 'Checking libunistring... '
UNISTRING_INCLUDES=
UNISTRING_LIBS=-lunistring
for dir in /opt/homebrew/include /usr/local/include /usr/include; do
    if [ -f "$dir/unistr.h" ]; then
        UNISTRING_INCLUDES="-I$dir"
        break
    fi
done
for dir in /opt/homebrew/lib /usr/local/lib /usr/lib; do
    if [ -f "$dir/libunistring.a" ] || \
       [ -f "$dir/libunistring.dylib" ] || \
       [ -f "$dir/libunistring.so" ]; then
        UNISTRING_LIBS="-L$dir -lunistring"
        break
    fi
done
if [ -z "$UNISTRING_INCLUDES" ]; then
    printf 'unistr.h not found\n' >&2
    printf 'Install libunistring (e.g. brew install libunistring)\n' >&2
    exit 1
fi
printf 'ok (%s)\n' "$UNISTRING_LIBS"

# ── BearSSL (vendored) ────────────────────────────────────────────────────────
BEARSSL_INC="$srcdir/vendor/BearSSL/inc"
BEARSSL_LIB_FILE="$srcdir/vendor/BearSSL/build/libbearssl.a"
if [ ! -f "$BEARSSL_LIB_FILE" ]; then
    printf 'Building vendored BearSSL...\n'
    make -C "$srcdir/vendor/BearSSL"
fi
printf 'BearSSL: %s\n' "$BEARSSL_LIB_FILE"

# ── Compile probes ────────────────────────────────────────────────────────────
tmpdir=$(mktemp -d)
trap 'rm -rf "$tmpdir"' EXIT

probe() {
    _name=$1; _src=$2
    printf '%s' "$_src" > "$tmpdir/probe_$_name.c"
    $CC $PTHREAD_CFLAGS -o "$tmpdir/probe_$_name" "$tmpdir/probe_$_name.c" \
        $PTHREAD_LIBS >/dev/null 2>&1
}

printf 'Probing platform features...\n'

if probe memmem '#include <string.h>
int main(void){memmem("a",1,"a",1);return 0;}'; then
    HAVE_MEMMEM=1; printf '  memmem: yes\n'
else
    HAVE_MEMMEM=0; printf '  memmem: no (will use fallback)\n'
fi

if probe strcasestr '#define _GNU_SOURCE
#include <string.h>
int main(void){strcasestr("a","a");return 0;}'; then
    HAVE_STRCASESTR=1; printf '  strcasestr: yes\n'
else
    HAVE_STRCASESTR=0; printf '  strcasestr: no (will use fallback)\n'
fi

if probe prio '#include <pthread.h>
int main(void){int i=PTHREAD_PRIO_INHERIT;return i;}'; then
    HAVE_PTHREAD_PRIO_INHERIT=1
else
    HAVE_PTHREAD_PRIO_INHERIT=0
fi

# ── git version ───────────────────────────────────────────────────────────────
GIT_HASH=$(git -C "$srcdir" log -1 --format='%H' 2>/dev/null || printf '?')
VERSION="20200209 + $GIT_HASH"

# ── Generate include/urweb/config.h ──────────────────────────────────────────
mkdir -p "$builddir/include/urweb"
CONFIG_H="$builddir/include/urweb/config.h"

def1()  { printf '#define %s 1\n' "$1"; }
undef() { printf '/* #undef %s */\n' "$1"; }
maybe() { if [ "$2" -eq 1 ] 2>/dev/null; then def1 "$1"; else undef "$1"; fi; }

{
printf '/* include/urweb/config.h -- generated by configure; do not edit */\n\n'
def1  HAVE_INTTYPES_H
def1  HAVE_STDINT_H
def1  HAVE_STDIO_H
def1  HAVE_STDLIB_H
def1  HAVE_STRING_H
def1  HAVE_STRINGS_H
def1  HAVE_SYS_STAT_H
def1  HAVE_SYS_TYPES_H
def1  HAVE_UNISTD_H
def1  HAVE_WCHAR_H
def1  STDC_HEADERS
maybe HAVE_MEMMEM               "$HAVE_MEMMEM"
maybe HAVE_STRCASESTR           "$HAVE_STRCASESTR"
maybe HAVE_PTHREAD_PRIO_INHERIT "$HAVE_PTHREAD_PRIO_INHERIT"
printf '\n'
printf '#define PACKAGE_NAME    "urweb"\n'
printf '#define PACKAGE_VERSION "20200209"\n'
printf '#define PACKAGE_STRING  "urweb 20200209"\n'
printf '#define PACKAGE_TARNAME "urweb"\n'
printf '#define PACKAGE_BUGREPORT ""\n'
printf '#define PACKAGE_URL ""\n'
printf '\n/* System extension macros */\n'
printf '#ifndef _GNU_SOURCE\n# define _GNU_SOURCE 1\n#endif\n'
printf '#ifndef _DARWIN_C_SOURCE\n# define _DARWIN_C_SOURCE 1\n#endif\n'
printf '#ifndef __EXTENSIONS__\n# define __EXTENSIONS__ 1\n#endif\n'
} > "$CONFIG_H"

printf 'Generated %s\n' "$CONFIG_H"

# ── Generate src/config.sml ───────────────────────────────────────────────────
mkdir -p "$builddir/src"
CONFIG_SML="$builddir/src/config.sml"

cat > "$CONFIG_SML" << SMLEOF
structure Config :> CONFIG = struct

val builddir = "$builddir"

val bin = "$BIN"
val srclib = "$SRCLIB"
val lib = "$LIB"
val includ = "$INCLUDE"
val sitelisp = "$SITELISP"

val ccompiler = "$CC"
val ccArgs = ""

val pgheader = "libpq-fe.h"
val msheader = "mysql.h"
val sqheader = "sqlite3.h"

val icuIncludes = "$ICU_INCLUDES"
val icuLibs = "$ICU_LIBS"

val bearssl = "$BEARSSL_LIB_FILE"

val libunistringIncludes = "$UNISTRING_INCLUDES"
val libunistringLibs = "$UNISTRING_LIBS"

val versionNumber  = "$VERSION"
val versionString  = "The Ur/Web compiler, version " ^ versionNumber

val pthreadCflags = "$PTHREAD_CFLAGS"
val pthreadLibs = "$PTHREAD_LIBS"

end
SMLEOF

printf 'Generated %s\n' "$CONFIG_SML"

# ── Generate build.ninja ──────────────────────────────────────────────────────
srcdir="$srcdir" builddir="$builddir" \
    CC="$CC" MLTON="$MLTON" \
    prefix="$prefix" BIN="$BIN" LIB="$LIB" SRCLIB="$SRCLIB" INCLUDE="$INCLUDE" \
    BEARSSL_INCLUDES="-I$BEARSSL_INC" \
    BEARSSL_LDFLAGS="-L$(dirname "$BEARSSL_LIB_FILE")" \
    BEARSSL_LIBS="-lbearssl" \
    BEARSSL_USE_VENDOR=1 \
    LIBUNISTRING_INCLUDES="$UNISTRING_INCLUDES" \
    LIBUNISTRING_LIBS="$UNISTRING_LIBS" \
    PTHREAD_CFLAGS="$PTHREAD_CFLAGS" \
    PTHREAD_LIBS="$PTHREAD_LIBS" \
    sh "$srcdir/scripts/gen_build.ninja.sh" > "$builddir/build.ninja"

printf 'Generated %s\n' "$builddir/build.ninja"

printf '\nConfiguration complete. Run '\''samu'\'' to build.\n'
